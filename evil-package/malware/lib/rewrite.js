// { author: 'ave' }

const fs = require('fs');

/** 
 * Prepend, append, and modify lines from an existing text files.
 * 
 * The following example comments an entire file:
 * 
 *     rewrite('code.js', {
 *         start: ()     => { return '// start of file\n' },
 *         line:  (line) => { return '//' + line }
 *         end:   ()     => { return '// end of file\n' },
 *     });
 */
module.exports = function(file, hooks) {
    // We need to access the old file while writing. It is renamed and later
    // deleted.
    const temp = file + '.temp'
    fs.renameSync(file, temp)

    readText = fs.readFileSync(temp, {
        encoding: 'utf8'
    })

    lines = readText.split('\n')

    if (hooks.line) {
        for (i = 0; i < lines.length; i++) {
            lines[i] = hooks.line(lines[i])
        }
    }

    if (hooks.start) lines.unshift(hooks.start())
    if (hooks.end) lines.push(hooks.end())

    writeText = lines.join('\n')

    fs.writeFileSync(file, writeText, {
        encoding: 'utf8',
        flag: 'wx'
    })

    fs.unlinkSync(temp)
}